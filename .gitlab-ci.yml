# General #####################################################################

stages:
  - lint
  - test

variables:
  ALLOWED_HOSTS: localhost
  POSTGRES_HOST: postgres
  POSTGRES_PORT: 5432
  POSTGRES_DB: $POSTGRES_DB
  POSTGRES_USER: $POSTGRES_USER
  POSTGRES_PASSWORD: $POSTGRES_PASSWORD
  POSTGRES_HOST_AUTH_METHOD: trust
  DEBUG: "false"
  SECRET_KEY: test
  SITE_ADDRESS: localhost:80
  DOCKER_BUILD_ENVIRONMENT: development
  DOCKER_CADDY_PORT_FORWARD: 8123

# Docs ########################################################################

lint docs:
  stage: lint
  image: node:latest
  script:
    - npm install markdownlint-cli
    - npx markdownlint docs

# Backend #####################################################################

.backend:
  stage: test
  image: docker/compose:1.29.2
  tags:
    - docker
  services:
    - docker:dind
    - postgres:12.6
    - redis:5.0
  before_script:
    - apk update && apk add make
    - make build
    - make migrate

pytest:
  extends: .backend
  script: make test
